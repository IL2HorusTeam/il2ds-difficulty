<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>IL-2 FB Difficulty Editor</title>

  <!-- Compiled and minified Bootstrap CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.6.2/css/bootstrap-select.min.css">

  <link rel="stylesheet" href="./static/css/bootstrap.vertical-tabs.min.css">
  <link rel="stylesheet" href="./static/css/bootstrap-switch.min.css">
  <link rel="stylesheet" href="./static/css/jumbotron-narrow.css">
  <link rel="stylesheet" href="./static/css/style.css">

  <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
  <![endif]-->

  <link href='./static/favicon.ico' rel="shortcut icon" type="image/x-icon">
</head>
<body>

<div class="container">
  <div class="header">
    <ul class="nav nav-pills pull-right" role="tablist">

      <li role="presentation">
        <div class="input-group" id="value_input_group">
          <input type="text"
                 id="value_input"
                 class="form-control"
                 maxlength="15"
                 placeholder="Value..." disabled>
          <div class="input-group-btn">
            <button type="button"
                    id="presets_selector"
                    class="btn btn-default dropdown-toggle disabled"
                    data-toggle="dropdown">Presets <span class="caret"></span>
            </button>
            <ul class="dropdown-menu dropdown-menu-right"
                id="presets_list"
                role="menu">
                {# Presets placeholder #}
            </ul>
          </div> <!-- /btn-group -->
        </div> <!-- /input-group -->
      </li>

    </ul>
    <h3 class="text-muted">IL-2 FB Difficulty Editor</h3>
  </div>

  <div class="jumbotron">
    <h2>Waiting for server response...</h2>
  </div>

  <div id="main" class="row">

    <div class="col-xs-3"> <!-- required for floating -->
      <!-- Nav tabs -->
      <ul id="tab_list" class="nav nav-tabs tabs-left">
        <!-- Tab list placeholder -->
      </ul>
    </div>

    <div class="col-xs-9">
      <!-- Tab panes -->
      <div id="tab_panes" class="tab-content">
        <!-- Tab panes placeholder -->
      </div>
    </div>
  </div>

  <footer class="footer">
    <p>
      Created by <a href='https://github.com/IL2HorusTeam/' target='_blank'>IL-2 Horus Team</a>
      with usage of <a href='https://github.com/IL2HorusTeam/il2fb-difficulty' target='_blank'>il2fb-difficulty</a>
      Python package for <b>game version <span class="game-version"></span></b>
    </p>
  </footer>

</div> <!-- /container -->

<a href="https://github.com/IL2HorusTeam/il2fb-difficulty" class="github-corner" aria-label="View source on Github"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#FD6C6C; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
<script src="https://code.jquery.com/jquery-1.11.1.min.js"></script>

<!-- Latest compiled and minified Bootstrap JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.6.2/js/bootstrap-select.min.js"></script>

<script src="./static/js/bootstrap-switch.min.js"></script>

<!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
<script src="./static/js/ie10-viewport-bug-workaround.js"></script>

<script type="text/javascript">
  $(function(){
    var $BASE_URL = "https://europe-west1-il2-horus-demo-services.cloudfunctions.net"
    // var $BASE_URL = "http://127.0.0.1:5000"
    , game_version = '4.13.4'
    , presets_selector = $('#presets_selector')
    , value_input = $('#value_input')
    , presets_list = $('#presets_list')
    , tab_list = $('#tab_list')
    , tab_panes = $('#tab_panes')
    , switch_options = {
        size: 'small'
      , onColor: 'success'
      , offColor: 'danger'
    }
    , prevent_api_requests = false

    $('.game-version').text(game_version)

    value_input.keyup(function(){
      var self = this
      , new_value = self.value.replace(/[^\d]/,'').replace(/^0+/, '')

      $(this).val(new_value)

      if (self.timer !== undefined) {
        clearInterval(self.timer)
      }
      self.timer = setInterval(function(){
        clearInterval(self.timer)
        delete self.timer

        apply_current_value()
      }, 300)
    })

    load_data()

    /* Functions ----------------------------------------------------------- */

    function get_url() {
      var args = Array.prototype.slice.call(arguments)
      return $BASE_URL + '/' + args.join('/')
    }

    function load_data(){
      value_input.prop('disabled', true)

      presets_list.empty()
      presets_selector.addClass('disabled')

      tab_list.empty()
      tab_panes.empty()

      $('#main').hide()
      $('.jumbotron').show()

      $.getJSON(get_url("difficulty-get-data"), function(result) {

        presets_selector.removeClass('disabled')
        value_input.prop('disabled', false)
        $('.jumbotron').hide()
        $('#main').show()

        result.presets.map(function(item) {
          presets_list
          .append($('<li>')
          .append($('<a>')
                  .data('value', item.value)
                  .text(item.title)
                  .click(on_preset_selected)
          ))
        })

        result.settings.map(function(item) {
          var tab_id = 'tab_' + item.tab.code
          , tab_link = $('<a>')
                       .attr('href', '#'+tab_id)
                       .attr('data-toggle', 'tab')
                       .text(item.tab.title)
          , tab_pane = $('<div>')
                       .attr('id', tab_id)
                       .addClass('tab-pane')

          tab_list.append($('<li>').append(tab_link))
          tab_panes.append(tab_pane)

          // Show current tab, so bootstrap-switch can be rendered
          tab_link.tab('show')

          item.parameters.map(function(parameter) {
            var input_id = 'param_' + parameter.code

            input = $('<input>')
                    .attr('type', 'checkbox')
                    .attr('id', input_id)
                    .attr('class', 'parameter')
                    .data('code', parameter.code)
                    .prop('checked', false)
            tab_pane
            .append($('<p>')
            .append(input)
            .append($('<label>')
                    .attr('for', input_id)
                    .attr('data-toggle', 'tooltip')
                    .attr('title', parameter.help_text)
                    .text(parameter.title)
                    .tooltip()
            ))

            input
            .bootstrapSwitch(switch_options)
            .on('switchChange.bootstrapSwitch', on_parameter_changed)
          })
        })

        tab_list.find('li:first a').tab('show')
        apply_current_value()
      })
    }

    function on_preset_selected(e){
      e.preventDefault()
      value_input.val($(this).data('value'))
      value_input.keyup()
    }

    function apply_current_value(){
      var difficulty = get_current_difficulty()
      , inputs = $('.parameter')

      inputs.off('switchChange.bootstrapSwitch')

      $.ajax({
        url: get_url("difficulty-decompose-value"),
        type: "POST",
        data: JSON.stringify({
          'difficulty': difficulty
        }),
        dataType: "json",
        contentType: "application/json; charset=utf-8",
        success: function(data) {

          if (data.difficulty != difficulty) {
            value_input.val(data.difficulty)
          }

          inputs.bootstrapSwitch('disabled', false)

          for (var code in data.parameters) {
            $('#param_' + code).bootstrapSwitch('state', data.parameters[code])
          }

          for (var i in data.locked) {
            $('#param_' + data.locked[i]).bootstrapSwitch('disabled', true)
          }

          inputs.on('switchChange.bootstrapSwitch', on_parameter_changed)
        }
      })
    }

    function on_parameter_changed(event, value){
      if (prevent_api_requests) {
        return
      }

      $.ajax({
        url: get_url("difficulty-toggle-value"),
        type: "POST",
        data: JSON.stringify({
            'difficulty': get_current_difficulty()
          , 'parameter': $(this).data('code')
          , 'value': value
        }),
        dataType: "json",
        contentType: "application/json; charset=utf-8",
        success: function(data) {
          value_input.val(data.difficulty)

          prevent_api_requests = true

          for (var i in data.side_effects.turns_on) {
            $('#param_' + data.side_effects.turns_on[i]).bootstrapSwitch('state', true)
          }

          for (var i in data.side_effects.turns_off) {
            $('#param_' + data.side_effects.turns_off[i]).bootstrapSwitch('state', false)
          }

          for (var i in data.side_effects.locks) {
            $('#param_' + data.side_effects.locks[i]).bootstrapSwitch('disabled', true)
          }

          for (var i in data.side_effects.unlocks) {
            $('#param_' + data.side_effects.unlocks[i]).bootstrapSwitch('disabled', false)
          }

          prevent_api_requests = false
        }
      })
    }

    function get_current_difficulty(){
      var result = parseInt(value_input.val().trim())
      if (isNaN(result)) {
        result = 0
      }
      return result
    }
  })
</script>

</body>
</html>
